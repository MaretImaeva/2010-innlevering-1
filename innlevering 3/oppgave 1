from collections import defaultdict
from itertools import combinations

class Skuespiller:
    def __init__(self, id, navn):
        self.id = id
        self.navn = navn


class Film:
    def __init__(self, id, navn, value: int):
        self.film_id = id
        self.film_navn = navn
        self.vekt = value


actors = "actors.tsv"
movies = "movies.tsv"


# actors = "marvel_actors.tsv"
# movies = "marvel_movies.tsv"    

film_dict = {} #nøkkelen er film IDen, verdien er et tuppel med film objektet og en liste av skuespillere i filmen


def les_film():
    fil = open(movies, 'r', encoding='utf-8')  
    data = fil
    for line in data:
        deler = [d.strip() for d in line.strip().split('\t')]
        if len(deler) < 3:
            print("Feil. Ikke riktig leset")
        noder = []  #skuespiller id-er     #blir aldri endret???
        film_dict[deler[0]] = (Film(deler[0], deler[1], float(deler[2])), noder)

linjer = []

print("Lest input filer")

def les_skue():
    fil = open(actors, 'r', encoding='utf-8')  
    data = fil       
    for line in data:
        deler = [d.strip() for d in line.strip().split('\t')]
        if len(deler) < 3: #sjekker at det er splittet riktig
            continue
        # node = Skuespiller(deler[0], deler[1])
        filmer = []
        for film in deler[2:]:
            filmer.append(film)
            if film in film_dict:
                film_dict[film][1].append(deler[0]) #legger til node IDen, men kan byttes ut med å legge til node objekt eller navn også
            elif film not in film_dict:
                # print("Lagt til alene node", deler[1])   
                linjer.append((deler[0], None, None))
                continue
    print("Lagret alle skuespillere, selv de ensomme")

    print("Laster...")

        

les_film()
les_skue()



###gjør koden mye raskere, den finner alle kombinasjonene av skuespillere i en film 
#Går fra o(n^3) til o(n^2)
for film_obj, actors in film_dict.values():
    for a, b in combinations(actors, 2):
        linjer.append((a, b, film_obj.vekt))




class Fil:
    def __init__(self):
        print("Fil laget.")
    # Skriv linjer (a, b, weight) til en TSV-fil
    with open("edges.tsv", "w", encoding="utf-8") as f:
        for a, b, vekt in linjer:
            f.write(f"{a}\t{b}\t{vekt}\n")




class Graf:
    def __init__(self, lines):
        self.V = set() #set av noder
        self.E = defaultdict(set) #kanter
        self.w = dict() #vektfunksjon
        self.naboer = defaultdict(list)

        # Bygg grafen fra linjer (kanter)
        for line in lines:
            # forventer (u, v, weight)
            if line is None or len(line) < 2:
                continue
            u, v, weight = line[0], line[1], line[2]

            if u is None or v is None:
                continue
            # sjekk for None 
            try:
                weight = float(weight) 
                if weight != 'None':
                    weight = weight
                else:
                    weight = 0.0
            except (ValueError, TypeError):
                weight = 0.0

            self.V.add(u)
            self.V.add(v)

            self.E[u].add(v)
            self.E[v].add(u)

            self.naboer[u].append((v, float(weight)))
            self.naboer[v].append((u, float(weight)))

            self.w[(u, v)] = float(weight)
            self.w[(v, u)] = float(weight)


        for film in film_dict.values(): 
            for actor in film[1]:
                self.V.add(actor)
                if actor not in self.E:
                    self.E[actor] = set()


    def finn_node(self, node_id): 
        if node_id not in self.V:
            return
        for node in self.V: #om noder legges inn som objekter, endre node til node.id
            if node == node_id:
                return node
            
    def hentV(self):
        return self.V
    
    def hentE(self):
        return self.E
    
    def hentW(self):
        return self.w
    
    def hent_naboer(self, node_id):
        return self.naboer[node_id]
    
G = Graf(linjer)

def ant_kanter():
    return len(linjer)

def hent_noder(G):
    return G.hentV()

def skriv_ut():
    print("Noder: ", len(hent_noder(G)),"\nKanter: ", ant_kanter())

def unpackGraf(G):
    try:
        V=G.hentV()
        E=G.hentE()
        w=G.hentW()
    except AttributeError:
        V,E,w = G
    return V,E,w


graf = Graf(linjer)
skriv_ut()
